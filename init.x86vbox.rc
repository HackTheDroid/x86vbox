# Copyright (C) 2016 The Android Open Source Project
#
# IMPORTANT: Do not create world writable files or directories.
# This is a common source of Android security bugs.
#
#******************************************************************************
#
# init.x86vbox.rc - startup script for x86vbox
#
# Copyright (c) 2016 Roger Ye.  All rights reserved.
#
# This is part of the build for virtual device x86vbox.
#
#******************************************************************************

on early-init
    mount debugfs debugfs /sys/kernel/debug
    
    write /proc/sys/kernel/ctrl-alt-del 1

    write /sys/module/xt_qtaguid/parameters/ctrl_write_limited N

    export force_s3tc_enable true
    export EGL_LOG_LEVEL info
#   export EGL_DRIVERS egl_dri2

on init
    # See storage config details at http://source.android.com/tech/storage/
    mkdir /mnt/media_rw/sdcard 0700 media_rw media_rw
    mkdir /storage/sdcard 0700 root root

    export EXTERNAL_STORAGE /storage/sdcard

    # Support legacy paths
    symlink /storage/sdcard /sdcard
    symlink /storage/sdcard /mnt/sdcard
    
    mkdir /storage/disk 0755 root root

on boot
    setsebool in_qemu 1
    restorecon /sys/qemu_trace/process_name
    restorecon /sys/qemu_trace/state
    restorecon /sys/qemu_trace/symbol
    setprop ARGH ARGH
    setprop net.eth0.gw 10.0.2.2
    setprop net.eth0.dns1 10.0.2.3
    setprop net.dns1 10.0.2.3
    setprop net.gprs.local-ip 10.0.2.15
    setprop ro.build.product generic
    setprop ro.product.device generic

    setprop ro.radio.use-ppp yes
# fake some battery state
    setprop status.battery.state Slow
    setprop status.battery.level 5
    setprop status.battery.level_raw  50
    setprop status.battery.level_scale 9

    # merge from system.prop
    setprop ro.config.sync yes
    setprop app.setupwizard.disable 0
    setprop ro.alarm.volume.adjustable true
    setprop ro.simulated.phone false
    # disable red frame boarder in eng build
    setprop persist.sys.strictmode.visual 0
    setprop persist.sys.strictmode.disable 1
    # workaround for h.265 slowness
    setprop sys.media.vdec.drop 0
    
# disable some daemons the emulator doesn't want
    stop dund
    stop akmd

# start essential services
#    start qemud
#    start goldfish-logcat
    start x86vbox-setup

    setprop ro.setupwizard.mode EMULATOR

# enable Google-specific location features,
# like NetworkLocationProvider and LocationCollector
    setprop ro.com.google.locationfeatures 1

# For the emulator, which bypasses Setup Wizard, you can specify
# account info for the device via these two properties.  Google
# Login Service will insert these accounts into the database when
# it is created (ie, after a data wipe).
#
#   setprop ro.config.hosted_account username@hosteddomain.org:password
#   setprop ro.config.google_account username@gmail.com:password
#
# You MUST have a Google account on the device, and you MAY
# additionally have a hosted account.  No other configuration is
# supported, and arbitrary breakage may result if you specify
# something else.

on fs
    mount_all /fstab.x86vbox

service x86vbox-setup /system/etc/init.x86vbox.sh
    user root
    group root
    oneshot

# fusewrapped external sdcard daemon running as media_rw (1023)
service fuse_sdcard /system/bin/sdcard -u 1023 -g 1023 -d /mnt/media_rw/sdcard /storage/sdcard
    class late_start
    disabled

 # Merged from android-x86
 service wpa_supplicant /system/bin/wpa_supplicant -c/data/misc/wifi/wpa_supplicant.conf \
    -iwlan0 -Dnl80211 \
    -O/data/misc/wifi/sockets \
    -e/data/misc/wifi/entropy.bin -g@android:wpa_wlan0
    #   we will start as root and wpa_supplicant will switch to user wifi
    #   after setting up the capabilities required for WEXT
    #   user wifi
    #   group wifi inet keystore
    class main
    socket wpa_wlan0 dgram 660 wifi wifi
    disabled

service dhcpcd_wlan0 /system/bin/dhcpcd -aABDKL
    class main
    disabled
    oneshot

service iprenew_wlan0 /system/bin/dhcpcd -n
    class main
    disabled
    oneshot

service dhcpcd_eth0 /system/bin/dhcpcd -ABDKL
    class main
    disabled
    oneshot

service iprenew_eth0 /system/bin/dhcpcd -n
    class main
    disabled
    oneshot

service dhcpcd_bt-pan /system/bin/dhcpcd -BKLG
    class late_start
    disabled
    oneshot

service iprenew_bt-pan /system/bin/dhcpcd -n
    class late_start
    disabled
    oneshot

service nativebridge /system/bin/enable_nativebridge
    class main
    disabled
    oneshot

service powerbtnd /system/bin/powerbtnd
    class late_start

service logcat /system/bin/logcat -v threadtime -f /data/log.txt
    class debug

service btattach /system/bin/btattach -Pbcm
    class main
    disabled
    oneshot

service wacom-input /system/bin/wacom-input
    disabled
    oneshot

service tablet-mode /system/bin/tablet-mode
    disabled
    oneshot

on property:init.svc.wpa_supplicant=stopped
    stop dhcpcd

on property:system_init.startsurfaceflinger=0
    # disable cursor blinking
    write /dev/tty0 "[?17;0;0c"
    start surfaceflinger
    stop console

on property:sys.boot_completed=1
    write /proc/sys/kernel/ctrl-alt-del 0
    exec -- /system/bin/logwrapper /system/bin/sh /system/etc/init.x86vbox.sh bootcomplete

on property:init.svc.bluetoothd=running
    exec -- /system/bin/logwrapper /system/bin/sh /system/etc/init.x86vbox.sh hci

on property:init.svc.bluetoothd=stopped
    exec -- /system/bin/logwrapper /system/bin/sh /system/etc/init.x86vbox.sh hci

on property:net.dns1=*
    exec -- /system/bin/logwrapper /system/bin/sh /system/etc/init.x86vbox.sh netconsole

on property:debug.logcat=1
    class_start debug

on property:persist.sys.nativebridge=1
    mkdir /data/arm 0775 system system
    start nativebridge

on property:persist.sys.nativebridge=0
    stop nativebridge

on property:debug.egl.hw=0
    setprop ro.kernel.qemu 1
 